# 자동 연결 가이드

## 개요

CarrotView 앱은 이제 C3 디바이스와 **완전 자동으로 연결**됩니다. 수동 작업이 필요 없습니다!

## 작동 방식

### 1. C3 디바이스 (서버)

C3가 부팅되면:
1. ✅ CarrotView 데이터 전송 서비스가 **자동으로 시작**됩니다 (systemd)
2. ✅ 포트 8080에서 연결을 **대기**합니다
3. ✅ 안드로이드 앱의 연결을 **기다립니다**

### 2. 안드로이드 앱 (클라이언트)

앱을 실행하면:
1. ✅ 마지막 연결 주소로 **자동 연결 시도** (0.5초 후)
2. ✅ 실패 시 로컬 네트워크에서 C3를 **자동 검색**
3. ✅ 발견되면 **자동으로 연결**
4. ✅ 연결 끊김 시 **자동 재연결**

## 사용자가 할 일

### 초기 설정 (한 번만)

#### C3 디바이스
```bash
# SSH 접속
ssh comma@<C3_IP>

# 디렉토리 이동
cd /data/openpilot/selfdrive/carrot

# 권한 설정
./setup_permissions.sh

# 자동 시작 설치
sudo ./install_autostart.sh
```

#### 안드로이드 앱
1. CarrotView APK 설치
2. 앱 실행
3. 완료! (자동으로 연결됨)

### 일상 사용

1. **C3 켜기** → 서비스 자동 시작 ✅
2. **앱 실행** → 자동 연결 ✅
3. **끝!** 🎉

## 자동 연결 설정

앱에서 **⚙️ 설정** 버튼을 눌러 다음을 조정할 수 있습니다:

### 앱 시작 시 자동 연결
- **ON (기본)**: 앱 실행 시 자동으로 C3에 연결
- **OFF**: 수동으로 "연결" 버튼을 눌러야 함

### 연결 끊김 시 자동 재연결
- **ON (기본)**: 연결이 끊어지면 자동으로 재연결 시도
- **OFF**: 연결이 끊어지면 수동으로 재연결해야 함

### 서버 포트
- 기본값: **8080**
- C3 설정과 동일해야 함

### 인증 토큰
- 기본값: **carrotview2024**
- C3 설정과 동일해야 함

## 연결 프로세스 상세

### 1단계: 마지막 주소 시도 (빠름)
```
앱 시작
  ↓
0.5초 대기 (UI 초기화)
  ↓
마지막 연결 주소 확인
  ↓
연결 시도 (3초 타임아웃)
  ↓
성공? → 완료! ✅
실패? → 2단계로
```

### 2단계: 자동 검색 (약간 느림)
```
로컬 네트워크 스캔
  ↓
192.168.x.1 ~ 192.168.x.254 확인
  ↓
포트 8080 열린 기기 찾기
  ↓
발견? → 연결 시도 → 완료! ✅
없음? → "수동으로 연결하세요" 메시지
```

### 3단계: 자동 재연결 (연결 끊김 시)
```
연결 끊김 감지
  ↓
5초 대기
  ↓
재연결 시도
  ↓
성공? → 완료! ✅
실패? → 5초 후 다시 시도
```

## 연결 상태 표시

앱 화면에서 현재 상태를 확인할 수 있습니다:

- **연결 안 됨** - 아직 연결되지 않음
- **자동 연결 중...** - 마지막 주소로 연결 시도 중
- **CarrotPilot 검색 중...** - 네트워크에서 C3 찾는 중
- **연결 중...** - C3에 연결하는 중
- **연결됨 (192.168.x.x:8080)** - 연결 성공! ✅
- **재연결 중...** - 연결이 끊어져서 재연결 시도 중
- **오류 - [메시지]** - 연결 실패

## 문제 해결

### 앱이 자동으로 연결되지 않음

**1. C3 서비스 확인**
```bash
ssh comma@<C3_IP>
cd /data/openpilot/selfdrive/carrot
./check_service.py
```

모든 항목이 ✓여야 합니다.

**2. 같은 네트워크 확인**
- C3와 안드로이드 기기가 같은 Wi-Fi에 연결되어 있는지 확인
- 핫스팟 사용 시 C3가 핫스팟에 연결되어 있는지 확인

**3. 방화벽 확인**
```bash
sudo iptables -L -n | grep 8080
```

포트 8080이 열려 있어야 합니다.

**4. 앱 설정 확인**
- 앱에서 **⚙️ 설정** 열기
- "앱 시작 시 자동 연결"이 **ON**인지 확인
- 포트가 **8080**인지 확인

### 연결이 자주 끊김

**1. Wi-Fi 신호 확인**
- C3와 안드로이드 기기가 가까이 있는지 확인
- Wi-Fi 신호가 강한지 확인

**2. 자동 재연결 활성화**
- 앱에서 **⚙️ 설정** 열기
- "연결 끊김 시 자동 재연결"이 **ON**인지 확인

**3. C3 서비스 재시작**
```bash
sudo systemctl restart carrotview-transmitter
```

### 수동 연결하고 싶음

앱에서:
1. **⚙️ 설정** 열기
2. "앱 시작 시 자동 연결" **OFF**
3. 앱 재시작
4. IP 주소 입력 후 "연결" 버튼 클릭

## 성능 최적화

### 빠른 연결을 위한 팁

1. **고정 IP 사용** (C3)
   - 라우터에서 C3에 고정 IP 할당
   - 마지막 주소로 빠르게 연결됨

2. **강한 Wi-Fi 신호**
   - C3와 안드로이드 기기를 가까이 배치
   - 5GHz Wi-Fi 사용 (가능한 경우)

3. **불필요한 앱 종료**
   - 백그라운드 앱이 네트워크를 사용하지 않도록

## 기술 세부사항

### 자동 검색 알고리즘

```kotlin
// 1. 마지막 주소 시도
if (lastAddress.isNotEmpty()) {
    connect(lastAddress)
    wait(3000ms)
    if (connected) return
}

// 2. 네트워크 스캔
val subnet = getLocalSubnet() // 예: 192.168.1
for (i in 1..254) {
    val ip = "$subnet.$i"
    if (isPortOpen(ip, 8080)) {
        connect(ip)
        if (connected) return
    }
}
```

### 자동 재연결 로직

```kotlin
// TCPClient 내부
while (autoReconnect && !connected) {
    try {
        connect()
        break
    } catch (e: Exception) {
        delay(reconnectInterval) // 기본 5초
    }
}
```

### 연결 타임아웃

- **연결 시도**: 10초
- **데이터 읽기**: 30초
- **재연결 간격**: 5초
- **자동 검색**: 각 IP당 1초

## 보안

자동 연결은 다음 보안 기능을 포함합니다:

1. **로컬 네트워크만** - 192.168.x.x, 10.x.x.x만 검색
2. **토큰 인증** - 연결 시 인증 토큰 확인
3. **타임스탬프 검증** - 재생 공격 방지
4. **암호화** - 데이터 압축 및 보호

## 요약

### ✅ 자동으로 되는 것
- C3 서비스 시작 (부팅 시)
- 앱 연결 (실행 시)
- 재연결 (끊김 시)
- C3 검색 (주소 모를 때)

### ❌ 수동으로 해야 하는 것
- 초기 설치 (한 번만)
- 설정 변경 (필요 시)

### 🎯 결론
**한 번 설정하면, 그 다음부터는 완전 자동!** 🚀
